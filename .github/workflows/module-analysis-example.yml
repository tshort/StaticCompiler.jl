name: Module-Wide Analysis

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Sunday at midnight
    - cron: '0 0 * * 0'

jobs:
  analyze-module:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup Julia
      uses: julia-actions/setup-julia@v1
      with:
        version: '1.10'

    - name: Install dependencies
      run: |
        julia --project=. -e 'using Pkg; Pkg.instantiate()'

    - name: Analyze entire module
      run: |
        julia --project=. << 'EOF'
        using StaticCompiler

        # Analyze your entire module
        # Replace YourModule with your actual module name
        println("ðŸ” Analyzing entire module...")

        module_analysis = analyze_module(YourModule, threshold=80, verbose=true)

        # Generate detailed reports
        results = module_analysis[:results]
        generate_ci_report(results, "module_analysis")

        # Generate GitHub Actions summary
        generate_github_actions_summary(results)

        # Create annotations
        annotate_github_actions(results, error_threshold=60, warning_threshold=80)

        # Check quality standards
        println("\n" * "="^70)
        println("QUALITY CHECK")
        println("="^70)

        summary = module_analysis[:summary]
        println("Total functions: $(summary[:total])")
        println("Ready: $(summary[:ready])")
        println("Average score: $(summary[:average_score])/100")
        println("Pass rate: $(round(summary[:pass_rate], digits=1))%")

        # Fail if quality is too low
        if summary[:pass_rate] < 75.0 || summary[:average_score] < 70
            println("\nâŒ Module quality below threshold!")
            exit(1)
        else
            println("\nâœ… Module quality acceptable!")
        end

        EOF

    - name: Upload module analysis
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: module-analysis
        path: |
          module_analysis.md
          module_analysis.json

    - name: Track quality over time
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        mkdir -p quality-history
        cp module_analysis.json quality-history/$(date +%Y-%m-%d).json
        echo "Quality report saved for historical tracking"
